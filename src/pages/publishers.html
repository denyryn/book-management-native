<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Publishers - Book Management</title>
  </head>
  <body>
    <!-- Publisher Table -->
    <table border="1" cellpadding="6">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="publisher-table-body">
        <!-- Publisher rows will be populated here -->
      </tbody>
    </table>

    <hr />

    <!-- Publisher Form -->
    <form id="publisher-form">
      <input type="hidden" id="publisher-id" />
      <label for="publisher-name">Name:</label>
      <input type="text" id="publisher-name" required />
      <button type="submit">Save</button>
      <button type="button" id="cancel-edit" style="display: none">
        Cancel
      </button>
    </form>

    <script type="module">
      import {
        fetchPublishers,
        addPublisher,
        updatePublisher,
        deletePublisher,
      } from "/public/js/publishers.js";

      const tableBody = document.getElementById("publisher-table-body");
      const form = document.getElementById("publisher-form");
      const idField = document.getElementById("publisher-id");
      const nameField = document.getElementById("publisher-name");
      const cancelBtn = document.getElementById("cancel-edit");

      // --- Render table ---
      async function loadPublishers() {
        const publishers = await fetchPublishers();
        tableBody.innerHTML = ""; // reset
        if (!publishers.success && publishers.error) {
          tableBody.innerHTML = `<tr><td colspan="3">${publishers.error}</td></tr>`;
          return;
        }
        publishers.forEach((pub) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${pub.id}</td>
            <td>${pub.name}</td>
            <td>
              <button data-edit="${pub.id}" data-name="${pub.name}">Edit</button>
              <button data-delete="${pub.id}">Delete</button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      }

      // --- Handle form submit ---
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = idField.value;
        const name = nameField.value.trim();
        if (!name) return;

        let result;
        if (id) {
          result = await updatePublisher(id, name);
        } else {
          result = await addPublisher(name);
        }

        if (result.success) {
          form.reset();
          idField.value = "";
          cancelBtn.style.display = "none";
          await loadPublishers();
        } else {
          alert(result.error || "Failed to save publisher");
        }
      });

      // --- Handle cancel edit ---
      cancelBtn.addEventListener("click", () => {
        form.reset();
        idField.value = "";
        cancelBtn.style.display = "none";
      });

      // --- Handle edit/delete clicks ---
      tableBody.addEventListener("click", async (e) => {
        if (e.target.dataset.edit) {
          idField.value = e.target.dataset.edit;
          nameField.value = e.target.dataset.name;
          cancelBtn.style.display = "inline";
        }

        if (e.target.dataset.delete) {
          if (confirm("Are you sure you want to delete this publisher?")) {
            const result = await deletePublisher(e.target.dataset.delete);
            if (result.success) {
              await loadPublishers();
            } else {
              alert(result.error || "Failed to delete publisher");
            }
          }
        }
      });

      // --- Initial load ---
      loadPublishers();
    </script>
  </body>
</html>
