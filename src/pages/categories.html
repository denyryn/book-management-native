<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Categories - Book Management</title>
  </head>
  <body>
    <!-- Category Table -->
    <table border="1" cellpadding="6">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="category-table-body">
        <!-- Category rows will be populated here -->
      </tbody>
    </table>

    <hr />

    <!-- Category Form -->
    <form id="category-form">
      <input type="hidden" id="category-id" />
      <label for="category-name">Name:</label>
      <input type="text" id="category-name" required />
      <button type="submit">Save</button>
      <button type="button" id="cancel-edit" style="display: none">
        Cancel
      </button>
    </form>

    <script type="module">
      import {
        fetchCategories,
        addCategory,
        updateCategory,
        deleteCategory,
      } from "/public/js/categories.js";

      const tableBody = document.getElementById("category-table-body");
      const form = document.getElementById("category-form");
      const idField = document.getElementById("category-id");
      const nameField = document.getElementById("category-name");
      const cancelBtn = document.getElementById("cancel-edit");

      // --- Render table ---
      async function loadCategories() {
        const categories = await fetchCategories();
        tableBody.innerHTML = ""; // reset
        if (!categories.success && categories.error) {
          tableBody.innerHTML = `<tr><td colspan="3">${categories.error}</td></tr>`;
          return;
        }
        categories.forEach((cat) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${cat.id}</td>
            <td>${cat.name}</td>
            <td>
              <button data-edit="${cat.id}" data-name="${cat.name}">Edit</button>
              <button data-delete="${cat.id}">Delete</button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      }

      // --- Handle form submit ---
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = idField.value;
        const name = nameField.value.trim();
        if (!name) return;

        let result;
        if (id) {
          result = await updateCategory(id, name);
        } else {
          result = await addCategory(name);
        }

        if (result.success) {
          form.reset();
          idField.value = "";
          cancelBtn.style.display = "none";
          await loadCategories();
        } else {
          alert(result.error || "Failed to save category");
        }
      });

      // --- Handle cancel edit ---
      cancelBtn.addEventListener("click", () => {
        form.reset();
        idField.value = "";
        cancelBtn.style.display = "none";
      });

      // --- Handle edit/delete clicks ---
      tableBody.addEventListener("click", async (e) => {
        if (e.target.dataset.edit) {
          idField.value = e.target.dataset.edit;
          nameField.value = e.target.dataset.name;
          cancelBtn.style.display = "inline";
        }

        if (e.target.dataset.delete) {
          if (confirm("Are you sure you want to delete this category?")) {
            const result = await deleteCategory(e.target.dataset.delete);
            if (result.success) {
              await loadCategories();
            } else {
              alert(result.error || "Failed to delete category");
            }
          }
        }
      });

      // --- Initial load ---
      loadCategories();
    </script>
  </body>
</html>
